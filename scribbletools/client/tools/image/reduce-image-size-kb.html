<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reduce Image Size - FREE Photo Size Reducer & Compression Tool</title>
    <meta name="description" content="Free image size reducer! Compress photos, reduce file size KB/MB without quality loss. Optimize JPEG, PNG, WebP for web, email, storage. Fast & free!">
    <meta name="keywords" content="reduce image size, image compressor, compress images online, photo size reducer, reduce file size, image size reducer, photo compressor, optimize images, image optimizer, web image compression, reduce photo KB, compress picture, image file reducer, photo file compressor, reduce picture size, image compression tool, photo optimization, reduce image MB, compress photo online, shrink image file, image size optimizer, photo size compressor, reduce jpeg size, reduce png size, compress webp, image file size reducer, photo file size compressor">
    <meta name="author" content="Scribble Tools">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://scribbletools.shramkavach.com/client/tools/image/reduce-image-size-kb.html">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Reduce Image Size - FREE Photo Size Reducer & Compression Tool">
    <meta property="og:description" content="Free image size reducer! Compress photos, reduce file size KB/MB without quality loss. Optimize JPEG, PNG, WebP for web, email, storage. Fast & free!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://scribbletools.shramkavach.com/client/tools/image/reduce-image-size-kb.html">
    <meta property="og:image" content="https://scribbletools.shramkavach.com/assets/og-image.svg">
    <meta property="og:site_name" content="Scribble Tools">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Reduce Image Size - FREE Photo Size Reducer & Compression Tool">
    <meta name="twitter:description" content="Free image size reducer! Compress photos, reduce file size KB/MB without quality loss. Optimize JPEG, PNG, WebP for web, email, storage. Fast & free!">
    <meta name="twitter:image" content="https://scribbletools.shramkavach.com/assets/og-image.svg">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="theme-color" content="#D9534F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Image Compressor">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Reduce Image Size Tool",
        "description": "Free online image size reducer for compressing photos and reducing file size while maintaining quality. Optimize images for web, email, and storage.",
        "url": "https://scribbletools.shramkavach.com/client/tools/image/reduce-image-size-kb.html",
        "applicationCategory": "MultimediaApplication",
        "operatingSystem": "Any",
        "permissions": "browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "Image compression",
            "File size reduction",
            "Quality optimization",
            "Multiple format support",
            "Batch processing"
        ]
    }
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #F8F4E8; color: #333; }
        .reduce-size-container { max-width: 800px; margin: 3em auto; background: #fff; border-radius: 1.2em; box-shadow: 0 4px 24px #eae3d5; padding: 2em 1.5em 2.5em 1.5em; }
        .handwritten { font-family: 'Caveat', cursive; }
        
        .upload-area { border: 3px dashed #D9534F; border-radius: 1em; padding: 3em 2em; text-align: center; margin: 2em 0; background: #FDFBF5; transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { background: #F0F8FF; border-color: #4682B4; }
        .upload-area.dragover { background: #E8F5E8; border-color: #228B22; }
        .upload-icon { font-size: 3em; color: #D9534F; margin-bottom: 1em; }
        
        .file-input { display: none; }
        .upload-btn { background: #D9534F; color: #fff; border: none; border-radius: 0.5em; padding: 1em 2em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .upload-btn:hover { background: #c9302c; }
        
        .size-options { margin: 2em 0; }
        .option-group { margin: 1em 0; }
        .option-label { font-weight: 600; margin-bottom: 0.5em; display: block; }
        .option-select, .option-input { width: 100%; padding: 0.8em; border: 2px solid #EAE3D5; border-radius: 0.5em; font-size: 1em; margin-bottom: 1em; }
        
        .reduce-btn { background: #228B22; color: #fff; border: none; border-radius: 0.5em; padding: 1em 2em; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; font-size: 1.1em; }
        .reduce-btn:hover { background: #1e7e1e; }
        .reduce-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .result-section { margin-top: 2em; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1em; margin: 1em 0; }
        .result-card { background: #F0F8FF; border: 1px solid #B0C4DE; border-radius: 0.5em; padding: 1em; text-align: center; }
        .result-card h4 { color: #4682B4; margin: 0 0 0.5em 0; }
        .result-card .value { font-size: 1.2em; font-weight: bold; color: #D9534F; }
        
        .preview-comparison { background: #F0FFF0; border: 1px solid #90EE90; border-radius: 0.5em; padding: 1em; margin: 1em 0; }
        .preview-comparison h4 { color: #228B22; margin: 0 0 0.5em 0; }
        .preview-images { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin: 1em 0; }
        .preview-container { text-align: center; }
        .preview-image { max-width: 100%; max-height: 200px; border-radius: 0.5em; margin: 0.5em 0; }
        
        .download-section { background: #F0F8FF; border: 1px solid #B0C4DE; border-radius: 0.5em; padding: 1em; margin: 1em 0; text-align: center; }
        .download-btn { background: #4682B4; color: #fff; border: none; border-radius: 0.5em; padding: 1em 2em; font-weight: 600; cursor: pointer; transition: all 0.2s; margin: 0.5em; }
        .download-btn:hover { background: #357abd; }
        
        .progress-bar { background: #f0f0f0; border-radius: 0.3em; height: 1rem; margin: 0.5em 0; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; transition: width 0.3s; }
        
        .size-warning { color: #dc2626; font-weight: 500; }
        .size-success { color: #059669; font-weight: 500; }
        
        @media (max-width: 600px) { 
            .reduce-size-container { padding: 1em 0.2em; }
            .result-grid { grid-template-columns: 1fr; }
            .preview-images { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="reduce-size-container">
    <h1 class="handwritten text-5xl text-[#D9534F] mb-4">Reduce Image Size</h1>
    <p style="font-size:1.2em; margin-bottom:1em;">Reduce image file size to meet upload limits or optimize for web/email. Fast, privacy-first, and free. No files are stored permanently.</p>

    <div style="margin-bottom: 1.5em;">
      <span style="color: #666;">Related:</span>
      <a href="/client/tools/image/image-compressor.html" style="color: #FF6B6B; text-decoration: none; margin: 0 0.5em;">Image Compressor</a>
      <a href="/client/tools/image/image-converter.html" style="color: #FF6B6B; text-decoration: none; margin: 0 0.5em;">Image Converter</a>
      <a href="/client/tools/image/increase-image-size-kb.html" style="color: #FF6B6B; text-decoration: none; margin: 0 0.5em;">Increase Image Size</a>
      <a href="/client/tools/image/grayscale-image.html" style="color: #FF6B6B; text-decoration: none; margin: 0 0.5em;">Grayscale Image</a>
    </div>

    <div style="background:#FFF3CD; border:1px solid #FFD700; border-radius:0.7em; padding:1em; margin-bottom:1.2em; color:#B8860B; font-weight:bold; font-size:1.1em;">
      üìè <b>Shrink file size while keeping acceptable quality.</b> All processing happens in your browser.
    </div>

    <section aria-labelledby="instructions-title" style="background: #F8FBFF; border-radius: 0.7em; padding: 1.5em; margin: 2em 0; border: 1px solid #4682B4;">
      <h2 id="instructions-title" style="color:#4682B4; margin-bottom: 1em; font-size: 1.5em;">How to Use</h2>
      <ol class="step-list" style="margin-left: 1.5em; line-height: 1.6;">
        <li><strong style="color: #4682B4">Upload Your Image:</strong>
          <ul style="margin: 0.5em 0 0.5em 1.5em; color: #666;">
            <li>Drag & drop your image into the upload area</li>
            <li>Or click "Choose File" to browse</li>
          </ul>
        </li>
        <li><strong style="color: #4682B4">Choose Target Size & Settings:</strong>
          <ul style="margin: 0.5em 0 0.5em 1.5em; color: #666;">
            <li>Select a target file size (KB) or enter a custom size</li>
            <li>Pick output format: JPEG, WebP, or PNG</li>
            <li>Choose a quality priority (balanced/quality/size)</li>
          </ul>
        </li>
        <li><strong style="color: #4682B4">Reduce & Download:</strong>
          <ul style="margin: 0.5em 0 0.5em 1.5em; color: #666;">
            <li>Click "Reduce Image Size" to process</li>
            <li>Compare before/after preview and size metrics</li>
            <li>Download the optimized image</li>
          </ul>
        </li>
      </ol>
    </section>

    <section class="example-section" style="background: #FDFBF5; border: 1px solid #FFEAA7; border-radius: 0.7em; padding: 1.5em; margin: 2em 0;">
      <h3 style="color: #4682B4; margin-bottom: 1em;">Common Uses & Tips</h3>
      <div style="margin-bottom: 1.2em;">
        <h4 style="color: #FF6B6B; margin-bottom: 0.5em;">üì¶ Common Uses</h4>
        <ul style="color: #666; margin-left: 1.2em;">
          <li>Meet upload limits for forms, portals, or email</li>
          <li>Speed up websites by shrinking large images</li>
          <li>Prepare images for social media sharing</li>
        </ul>
      </div>
      <div>
        <h4 style="color: #FF6B6B; margin-bottom: 0.5em;">üí° Pro Tips</h4>
        <ul style="color: #666; margin-left: 1.2em;">
          <li>Use WebP for best size/quality on modern browsers</li>
          <li>Balance target size and quality priority</li>
          <li>Consider resizing dimensions for large source images</li>
        </ul>
      </div>
    </section>

    <section class="privacy-section">
      <h2 style="color:#D9534F;">Privacy Notice</h2>
      <div style="background: #FFF3CD; border: 1px solid #FFEAA7; border-radius: 0.5em; padding: 1em; margin: 1em 0; font-size: 0.9em; color: #856404;">
        <strong>üîí Your files are processed only in your browser and are not uploaded. Temporary data is cleared automatically.</strong>
      </div>
    </section>

    <div class="upload-area" id="upload-area">
        <div class="upload-icon">üìè</div>
        <h3>Drag & Drop your image here</h3>
        <p>or click to browse files</p>
                <input type="file" id="file-input" class="file-input" accept="image/*">
        <button class="upload-btn" id="choose-file-btn">Choose File</button>
        <div id="upload-progress-bar" style="display:none; width:100%; background:#F0F8FF; border-radius:0.5em; margin-top:1.2em; height:1.5em; overflow:hidden; border:1px solid #B0C4DE; position:relative;">
          <div id="upload-progress-fill" style="height:100%; width:0; background:linear-gradient(90deg,#D9534F,#F0AD4E,#5BC0DE,#5CB85C,#A569BD); transition:width 0.2s;"></div>
          <span id="upload-progress-text" style="position:absolute; left:50%; top:0; transform:translateX(-50%); color:#333; font-weight:600; line-height:1.5em; font-size:1em;">Uploading: 0%</span>
        </div>
    </div>

            <div class="size-options" id="size-options" style="display: none;">
        <h3 style="color: #D9534F; margin-bottom: 1em;">Size Reduction Options</h3>
        
        <div class="option-group">
            <label class="option-label">Target File Size:</label>
            <select id="target-size" class="option-select">
                <option value="100">100 KB</option>
                <option value="200">200 KB</option>
                <option value="500">500 KB</option>
                <option value="1000">1 MB</option>
                <option value="2000">2 MB</option>
                <option value="custom">Custom Size</option>
            </select>
        </div>
        
        <div class="option-group" id="custom-size-div" style="display: none;">
            <label class="option-label">Custom Size (KB):</label>
            <input type="number" id="custom-size" min="10" max="10000" class="option-input" placeholder="Enter size in KB">
        </div>
        
        <div class="option-group">
            <label class="option-label">Output Format:</label>
            <select id="output-format" class="option-select">
                <option value="jpeg">JPEG (Best for photos)</option>
                <option value="webp">WebP (Modern, smaller)</option>
                <option value="png">PNG (Lossless)</option>
            </select>
        </div>
        
        <div class="option-group">
            <label class="option-label">Quality Priority:</label>
            <select id="quality-priority" class="option-select">
                <option value="balanced">Balanced</option>
                <option value="quality">High Quality</option>
                <option value="size">Smallest Size</option>
            </select>
        </div>
        
        <button class="reduce-btn" id="reduce-size-btn">Reduce Image Size</button>
    </div>
    
    <div class="result-section" id="result-section" style="display: none;">
        <div class="result-grid" id="result-grid"></div>
        <div class="preview-comparison" id="preview-comparison"></div>
        <div class="download-section" id="download-section"></div>
    </div>
</div>

<section class="feature-list" style="max-width:800px; margin: 1.5em auto; background: #FDFBF5; border-radius: 0.7em; padding: 1.2em; border: 1px solid #FFEAA7;">
  <h2 style="color: #4682B4; margin-bottom: 1em;">Key Features</h2>
  <ul style="list-style: none; padding-left: 0;">
    <li>‚úì Target file size with custom option</li>
    <li>‚úì Multiple output formats (JPEG/WebP/PNG)</li>
    <li>‚úì Quality priority: balanced/quality/size</li>
    <li>‚úì Before/after preview and metrics</li>
    <li>‚úì Works entirely in your browser (privacy-first)</li>
    <li>‚úì Instant download of optimized image</li>
  </ul>
</section>

<nav class="recent-tools" aria-label="Recently used tools" style="max-width:800px; margin: 1.5em auto; background: #F8F9FA; border-radius: 0.7em; padding: 1.2em;">
  <strong>Recent Tools:</strong>
  <div class="recent-tools-list" style="display: inline-block;">
    <a href="/client/tools/image/increase-image-size-kb.html">Increase Image Size</a>
    <a href="/client/tools/image/image-compressor.html">Image Compressor</a>
    <a href="/client/tools/image/image-converter.html">Image Converter</a>
    <span class="separator" style="margin: 0 0.5em; color: #999;">‚Ä¢</span>
    <a href="#" id="clear-recent" style="color: #D9534F; font-size: 0.9em;">Clear History</a>
  </div>
</nav>

<!-- Add loading overlay HTML at the end of body -->
<div id="loading-overlay" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.92); align-items:center; justify-content:center;">
  <div style="text-align:center;">
    <div class="scribble-loader" aria-label="Processing, please wait...">
      <div class="scribble-dot"></div>
      <div class="scribble-dot"></div>
      <div class="scribble-dot"></div>
      <div class="scribble-dot"></div>
      <div class="scribble-dot"></div>
    </div>
    <div style="font-family:'Caveat',cursive; font-size:2.2em; color:#D9534F; margin-top:1.2em;">Reducing...</div>
    <div style="font-size:1.1em; color:#333; margin-top:0.5em;">Please wait while we reduce your image size.</div>
  </div>
</div>
<style>
.scribble-loader {
  display: flex;
  gap: 0.5em;
  justify-content: center;
  align-items: center;
  margin-top: 2em;
}
.scribble-dot {
  width: 0.8em;
  height: 0.8em;
  background: #D9534F;
  border-radius: 50%;
  animation: scribble-bounce 1.4s ease-in-out infinite both;
}
.scribble-dot:nth-child(1) { animation-delay: -0.32s; }
.scribble-dot:nth-child(2) { animation-delay: -0.16s; }
.scribble-dot:nth-child(3) { animation-delay: 0s; }
.scribble-dot:nth-child(4) { animation-delay: 0.16s; }
.scribble-dot:nth-child(5) { animation-delay: 0.32s; }
@keyframes scribble-bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
.conversion-success-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #E8F5E8;
  border: 2px solid #5CB85C;
  border-radius: 0.7em;
  padding: 1.2em 1em 1.5em 1em;
  margin-bottom: 1em;
  margin-top: 0.5em;
  box-shadow: 0 2px 12px #eae3d5;
}
.success-icon {
  font-size: 2.2em;
  color: #5CB85C;
  margin-bottom: 0.3em;
}
.success-message {
  font-size: 1.15em;
  color: #228B22;
  font-family: 'Caveat', cursive;
  margin-bottom: 0.7em;
  text-align: center;
}
.download-btn {
  display: inline-block;
  margin-top: 0.5em;
  margin-bottom: 0.2em;
  font-size: 1.08em;
  padding: 0.9em 2em;
}
@media (max-width: 600px) { .preview-images { grid-template-columns: 1fr; } }
</style>

<script>
// Recent tools functionality (shared pattern)
const RECENT_TOOLS_KEY = 'recentImageTools';
const MAX_RECENT_TOOLS = 4;

function initRecentTools() {
  const currentToolData = { name: 'Reduce Image Size', url: window.location.pathname };
  addToRecentTools(currentToolData);
  updateRecentToolsList();
  const clearRecentBtn = document.getElementById('clear-recent');
  if (clearRecentBtn) {
    clearRecentBtn.onclick = function(e) {
      e.preventDefault();
      localStorage.removeItem(RECENT_TOOLS_KEY);
      updateRecentToolsList();
    };
  }
}
function addToRecentTools(toolData) {
  let recentTools = JSON.parse(localStorage.getItem(RECENT_TOOLS_KEY) || '[]');
  recentTools = recentTools.filter(tool => tool.url !== toolData.url);
  recentTools.unshift(toolData);
  recentTools = recentTools.slice(0, MAX_RECENT_TOOLS);
  localStorage.setItem(RECENT_TOOLS_KEY, JSON.stringify(recentTools));
}
function updateRecentToolsList() {
  const recentToolsList = document.querySelector('.recent-tools-list');
  if (!recentToolsList) return;
  const recentTools = JSON.parse(localStorage.getItem(RECENT_TOOLS_KEY) || '[]');
  if (recentTools.length === 0) {
    recentToolsList.innerHTML = '<span style="color: #666;">No recent tools</span>';
    return;
  }
  const toolLinks = recentTools
    .filter(tool => tool.url !== window.location.pathname)
    .map(tool => `<a href="${tool.url}">${tool.name}</a>`) 
    .join('<span class="separator" style="margin: 0 0.5em; color: #999;">‚Ä¢</span>');
  recentToolsList.innerHTML = toolLinks +
    '<span class="separator" style="margin: 0 0.5em; color: #999;">‚Ä¢</span>' +
    '<a href="#" id="clear-recent" style="color: #D9534F; font-size: 0.9em;">Clear History</a>';
  const clearRecentBtn = document.getElementById('clear-recent');
  if (clearRecentBtn) {
    clearRecentBtn.onclick = function(e) {
      e.preventDefault();
      localStorage.removeItem(RECENT_TOOLS_KEY);
      updateRecentToolsList();
    };
  }
}
if (document.readyState !== 'loading') {
  initRecentTools();
} else {
  document.addEventListener('DOMContentLoaded', initRecentTools);
}
                    function initializeReduceImageSize() {
                        if (window.__reduceImageInit) return;
                        window.__reduceImageInit = true;
                        
                        const uploadArea = document.getElementById('upload-area');
                        const fileInput = document.getElementById('file-input');
                        const chooseFileBtn = document.getElementById('choose-file-btn');
                        const uploadProgressBar = document.getElementById('upload-progress-bar');
                        const uploadProgressFill = document.getElementById('upload-progress-fill');
                        const uploadProgressText = document.getElementById('upload-progress-text');
                        const sizeOptions = document.getElementById('size-options');
                        const targetSize = document.getElementById('target-size');
                        const customSizeDiv = document.getElementById('custom-size-div');
                        const customSize = document.getElementById('custom-size');
                        const reduceSizeBtn = document.getElementById('reduce-size-btn');
                        const resultSection = document.getElementById('result-section');
                        const resultGrid = document.getElementById('result-grid');
                        const previewComparison = document.getElementById('preview-comparison');
                        const downloadSection = document.getElementById('download-section');
                        const loadingOverlay = document.getElementById('loading-overlay');

                        let uploadedFile = null;
                        let originalImageData = null;

                        // Upload area event listeners
                        chooseFileBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            fileInput.click();
                        });
                        
                        uploadArea.addEventListener('click', (e) => {
                            // Only trigger if the user directly clicks on the background ‚Äî not on children like the button
                            if (e.target === uploadArea) {
                                fileInput.click();
                            }
                        });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    startUploadProgress(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    startUploadProgress(e.target.files[0]);
                    fileInput.value = '';
                }
            });

                            // Target size change handler
                targetSize.addEventListener('change', () => {
                    if (targetSize.value === 'custom') {
                        customSizeDiv.style.display = 'block';
                    } else {
                        customSizeDiv.style.display = 'none';
                    }
                });

                            function startUploadProgress(file) {
                                // File size validation
                                if (file.size < 10 * 1024) {
                                    alert('File size must be at least 10 KB');
                                    return;
                                }
                                if (file.size > 10 * 1024 * 1024) {
                                    alert('File size must be less than 10 MB');
                                    return;
                                }

                                // Hide options/results, show progress bar
                                sizeOptions.style.display = 'none';
                                resultSection.style.display = 'none';
                                uploadProgressBar.style.display = 'block';
                                uploadProgressBar.style.pointerEvents = 'auto';
                                uploadProgressFill.style.width = '0%';
                                uploadProgressText.textContent = 'Uploading: 0%';
                                
                                let percent = 0;
                                const duration = 800 + Math.random()*400;
                                const start = Date.now();
                                
                                function animate() {
                                    percent = Math.min(100, Math.round(((Date.now()-start)/duration)*100));
                                    uploadProgressFill.style.width = percent + '%';
                                    uploadProgressText.textContent = 'Uploading: ' + percent + '%';
                                    if (percent < 100) {
                                        requestAnimationFrame(animate);
                                    } else {
                                        setTimeout(() => {
                                            uploadProgressBar.style.display = 'none';
                                            uploadProgressBar.style.pointerEvents = 'none';
                                            uploadedFile = file;
                                            sizeOptions.style.display = 'block';
                                        }, 200);
                                    }
                                }
                                animate();
                            }

            reduceSizeBtn.addEventListener('click', reduceImageSize);

                            async function reduceImageSize() {
                    if (!uploadedFile) return;

                    const targetSizeKB = targetSize.value === 'custom' ? 
                        parseInt(customSize.value) : parseInt(targetSize.value);
                    
                    if (targetSize.value === 'custom' && (!customSize.value || customSize.value < 10)) {
                        alert('Please enter a valid custom size (minimum 10 KB)');
                        return;
                    }

                    loadingOverlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';

                    const outputFormat = document.getElementById('output-format').value;
                    const qualityPriority = document.getElementById('quality-priority').value;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = async function() {
                    // Start with original dimensions
                    let width = img.width;
                    let height = img.height;
                    let quality = 0.8;

                    // Adjust based on quality priority
                    if (qualityPriority === 'size') {
                        quality = 0.6;
                        width = Math.round(width * 0.8);
                        height = Math.round(height * 0.8);
                    } else if (qualityPriority === 'quality') {
                        quality = 0.9;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // Draw image
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to blob with initial settings
                    canvas.toBlob(async (blob) => {
                        if (blob) {
                            const finalBlob = await optimizeForTargetSize(blob, targetSizeKB, canvas, outputFormat, qualityPriority);
                            displayResults(finalBlob);
                        } else {
                            alert('Error processing image. Please try again.');
                        }
                        loadingOverlay.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }, `image/${outputFormat}`, quality);
                };

                img.src = URL.createObjectURL(uploadedFile);
            }

            // Asynchronous function to compress image to target size (binary search for best quality)
            async function optimizeForTargetSize(initialBlob, targetSizeKB, canvas, format, priority) {
                let minQuality = 0.1;
                let maxQuality = 0.98;
                let width = canvas.width;
                let height = canvas.height;
                let bestBlob = initialBlob;
                let bestDelta = Math.abs(initialBlob.size/1024 - targetSizeKB);
                let tolerance = targetSizeKB < 50 ? 1.2 : 4.0; // KB, as tight as browser precision allows
                let limitTries = 14; // Binary search tries max
                
                // Only do binary search for lossy (jpeg/webp), for PNG just try once
                if (format === 'png') {
                    return initialBlob;
                }

                // Binary search for best quality that gets as close as possible to requested size
                let low = minQuality, high = maxQuality;
                let found = false;
                let lastBlob = null, lastSize = null;

                for (let i=0; i<limitTries; ++i) {
                    let quality = (low + high) / 2;
                    let tempBlob = await new Promise(res => {
                        // To ensure resizing is preserved if used,
                        let tempCanvas = document.createElement('canvas');
                        tempCanvas.width = width;
                        tempCanvas.height = height;
                        let tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(canvas, 0, 0, width, height);
                        tempCanvas.toBlob(res, `image/${format}`, quality);
                    });
                    if (!tempBlob) break;
                    let s = tempBlob.size / 1024;
                    let delta = Math.abs(s - targetSizeKB);

                    // Track best blob so far (closest, but prefer not to exceed the limit if possible)
                    if (s <= targetSizeKB + tolerance && delta < bestDelta) {
                        bestBlob = tempBlob;
                        bestDelta = delta;
                        if (delta <= tolerance) found = true;
                    }
                    // Adjust search bounds
                    if (s > targetSizeKB + tolerance) {
                        // Too large: lower quality
                        high = quality;
                    } else {
                        // Too small (or good): raise quality
                        low = quality;
                    }
                    lastBlob = tempBlob;
                    lastSize = s;
                }
                // fallback: if bestBlob is not actually close, return minimal size
                return bestBlob || lastBlob || initialBlob;
            }

            function displayResults(blob) {
                const originalSize = (uploadedFile.size / 1024).toFixed(2);
                const finalSize = (blob.size / 1024).toFixed(2);
                const sizeReduction = (uploadedFile.size - blob.size) / 1024;
                const reductionPercent = ((sizeReduction / (uploadedFile.size / 1024)) * 100).toFixed(1);

                const sizeClass = sizeReduction > 0 ? 'size-success' : 'size-warning';
                const sizeText = sizeReduction > 0 ? `${sizeReduction.toFixed(2)} KB saved` : `${Math.abs(sizeReduction).toFixed(2)} KB larger`;

                                    resultGrid.innerHTML = `
                        <div class="result-card">
                            <h4>üìä Original Size</h4>
                            <div class="value">${originalSize} KB</div>
                        </div>
                        <div class="result-card">
                            <h4>üìä Final Size</h4>
                            <div class="value">${finalSize} KB</div>
                        </div>
                        <div class="result-card">
                            <h4>üìà Size Reduction</h4>
                            <div class="value ${sizeClass}">${sizeText}</div>
                        </div>
                        <div class="result-card">
                            <h4>üìä Reduction %</h4>
                            <div class="value ${sizeClass}">${reductionPercent}%</div>
                        </div>
                    `;

                    // Before & After Comparison
                    const originalUrl = URL.createObjectURL(uploadedFile);
                    const finalUrl = URL.createObjectURL(blob);
                    previewComparison.innerHTML = `
                        <h4>üñºÔ∏è Before & After Comparison</h4>
                        <div class="preview-images">
                            <div class="preview-container">
                                <h5>Original Image</h5>
                                <img src="${originalUrl}" alt="Original" class="preview-image">
                                <p>${originalSize} KB</p>
                            </div>
                            <div class="preview-container">
                                <h5>Reduced Image</h5>
                                <img src="${finalUrl}" alt="Reduced" class="preview-image">
                                <p>${finalSize} KB</p>
                            </div>
                        </div>
                    `;

                    // Download section
                    const url = URL.createObjectURL(blob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = `reduced_image.${document.getElementById('output-format').value}`;
                    downloadLink.className = 'download-btn';
                    downloadLink.textContent = 'Download Reduced Image';

                    downloadSection.innerHTML = `
                        <div class="conversion-success-card">
                            <div class="success-icon">‚úÖ</div>
                            <div class="success-message">Your image has been <b>successfully reduced!</b></div>
                        </div>
                    `;
                    downloadSection.appendChild(downloadLink);
                    resultSection.style.display = 'block';
            }
        }

        // SPA-friendly: Use a local flag on the upload area to prevent double listeners, but allow re-init on navigation
        function spaInitReduceImageSize() {
            const uploadArea = document.getElementById('upload-area');
            if (!uploadArea) return;
            if (!uploadArea.__reduceImageInit) {
                initializeReduceImageSize();
                uploadArea.__reduceImageInit = true;
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', spaInitReduceImageSize);
        } else {
            spaInitReduceImageSize();
        }
        // Expose function globally for SPA compatibility
        window.initializeReduceImageSize = initializeReduceImageSize;
        window.spaInitReduceImageSize = spaInitReduceImageSize;
    </script>
</body>
</html>
